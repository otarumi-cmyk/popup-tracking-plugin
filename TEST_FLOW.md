# ポップアップトラッキングプラグイン - テストフロー

## 📋 テスト環境の準備

### 1. プラグインのインストール
1. WordPress管理画面にログイン
2. 「プラグイン」→「新規追加」
3. `popup-tracking-plugin.zip` をアップロードして有効化

### 2. ブラウザ開発者ツールの準備
1. テスト用の記事ページを開く
2. `F12` キーで開発者ツールを開く
3. 「Console」タブを選択
4. コンソールのログをクリア（右クリック → 「Clear console」）

---

## 🧪 テスト項目一覧

### A. ポップアップ（モーダル）のテスト

#### A-1. 基本表示テスト
**前提条件:**
- ポップアップが有効になっている
- 画像が設定されている
- 対象記事でテストする

**テスト手順:**
1. 記事ページを開く
2. ポップアップが表示されるのを待つ（デフォルト: 5秒後）
3. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 📊 Recording POPUP impression
   ```
4. ダッシュボードで表示数が増えているか確認

**確認ポイント:**
- ✅ ポップアップが表示される
- ✅ コンソールに「Recording POPUP impression」ログが表示される
- ✅ セッションIDが表示されている
- ✅ CTA ID、バリアント、記事IDが正しい
- ✅ ダッシュボードの表示数が1増える

---

#### A-2. クリックテスト
**前提条件:**
- ポップアップが表示されている（A-1完了）

**テスト手順:**
1. ポップアップの画像をクリック
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 🖱️ Recording POPUP click
   ```
3. ダッシュボードでクリック数が増えているか確認

**確認ポイント:**
- ✅ コンソールに「Recording POPUP click」ログが表示される
- ✅ 表示が記録されている状態でクリックが記録される（`impressionRecorded: true`）
- ✅ 新しいタブでリンク先が開く
- ✅ ダッシュボードのクリック数が1増える
- ✅ CTRが正しく計算される（クリック数 / 表示数）

---

#### A-3. 重複防止テスト
**前提条件:**
- ポップアップが表示されている（A-1完了）

**テスト手順:**
1. ポップアップの画像を連続でクリック（複数回）
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] ⚠️ Popup click already handled (duplicate prevented)
   ```
3. ダッシュボードでクリック数が1回だけ増えているか確認

**確認ポイント:**
- ✅ 連続クリックでも1回だけ記録される
- ✅ コンソールに重複防止のログが表示される
- ✅ ダッシュボードのクリック数が1だけ増える

---

#### A-4. 表示されていない状態でのクリック防止テスト
**前提条件:**
- ポップアップが表示されていない状態

**テスト手順:**
1. ポップアップを閉じる（Xボタンまたは背景クリック）
2. JavaScriptで直接クリックイベントを発火させる（開発者ツールで）
3. コンソールでエラーログを確認

**確認ポイント:**
- ✅ 表示されていない状態でのクリックは無視される
- ✅ クリック数が増えない

---

### B. フローティングポップアップ（右下）のテスト

#### B-1. PC環境での表示テスト
**前提条件:**
- フローティングポップアップが有効になっている
- PCブラウザでテストする（画面幅768px以上）
- 画像が設定されている

**テスト手順:**
1. PCブラウザで記事ページを開く
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 🚀 initFloating called (右下フローティングポップアップ)
   [PopupTracking Debug XX:XX:XX] 📊 Recording FLOATING POPUP impression
   ```
3. ダッシュボードで表示数が増えているか確認

**確認ポイント:**
- ✅ 右下にフローティングポップアップが表示される
- ✅ コンソールに「Recording FLOATING POPUP impression」ログが表示される
- ✅ PC判定が正しい（`windowWidth: 1920`など）
- ✅ ダッシュボードの表示数が1増える

---

#### B-2. モバイル環境での非表示テスト
**前提条件:**
- フローティングポップアップが有効になっている

**テスト手順:**
1. ブラウザの開発者ツールでモバイル表示に切り替え（画面幅768px以下）
2. 記事ページをリロード
3. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 📱 Floating popup: Mobile device detected, not showing
   ```
4. 右下にフローティングポップアップが表示されないことを確認

**確認ポイント:**
- ✅ モバイルでは表示されない
- ✅ コンソールにモバイル判定のログが表示される
- ✅ ダッシュボードの表示数が増えない

---

#### B-3. クリックテスト
**前提条件:**
- フローティングポップアップが表示されている（B-1完了）

**テスト手順:**
1. フローティングポップアップをクリック
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 🖱️ Recording FLOATING POPUP click
   ```
3. ダッシュボードでクリック数が増えているか確認

**確認ポイント:**
- ✅ コンソールに「Recording FLOATING POPUP click」ログが表示される
- ✅ 表示が記録されている状態でクリックが記録される
- ✅ 新しいタブでリンク先が開く
- ✅ ダッシュボードのクリック数が1増える

---

### C. フローティングバナー（下側横長）のテスト

#### C-1. 表示テスト
**前提条件:**
- フローティングバナーが有効になっている
- PC/SP画像が設定されている

**テスト手順:**
1. 記事ページを開く
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 🚀 initFloatingBanner called
   [PopupTracking Debug XX:XX:XX] ✅ Floating banner session ID created/using existing
   [PopupTracking Debug XX:XX:XX] 📊 Recording FLOATING BANNER (bottom) impression
   ```
3. ダッシュボード（フローティングバナー）で表示数が増えているか確認

**確認ポイント:**
- ✅ 画面下にフローティングバナーが表示される
- ✅ コンソールに「Recording FLOATING BANNER (bottom) impression」ログが表示される
- ✅ セッションIDが作成/取得されている
- ✅ PCではPC画像、SPではSP画像が表示される
- ✅ ダッシュボードの表示数が1増える

---

#### C-2. 画像読み込み待ちテスト
**前提条件:**
- フローティングバナーが有効になっている
- 画像の読み込みが遅い場合

**テスト手順:**
1. ネットワークスロットリングを「Slow 3G」に設定（開発者ツール）
2. 記事ページを開く
3. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] ⏳ Floating banner images not loaded yet, waiting...
   [PopupTracking Debug XX:XX:XX] 📊 Recording FLOATING BANNER (bottom) impression (after image load)
   ```
4. 画像が読み込まれた後にバナーが表示されることを確認

**確認ポイント:**
- ✅ 画像読み込み待ちのログが表示される
- ✅ 画像読み込み後に表示数が記録される
- ✅ 画像が表示された後にバナーが表示される

---

#### C-3. クリックテスト
**前提条件:**
- フローティングバナーが表示されている（C-1完了）

**テスト手順:**
1. フローティングバナーをクリック
2. コンソールで以下のログを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 🖱️ Recording FLOATING BANNER (bottom) click
   ```
3. ダッシュボードでクリック数が増えているか確認

**確認ポイント:**
- ✅ コンソールに「Recording FLOATING BANNER (bottom) click」ログが表示される
- ✅ 表示が記録されている状態でクリックが記録される
- ✅ 新しいタブでリンク先が開く
- ✅ ダッシュボードのクリック数が1増える

---

#### C-4. バツボタンなしの確認
**前提条件:**
- フローティングバナーが表示されている

**テスト手順:**
1. フローティングバナーを確認
2. バツボタンがないことを確認

**確認ポイント:**
- ✅ バツボタンが表示されない
- ✅ ユーザーが閉じることができない

---

### D. カテゴリーフィルターのテスト

#### D-1. フローティングポップアップのカテゴリーフィルター
**前提条件:**
- フローティングポップアップが有効になっている
- カテゴリー設定がされている

**テスト手順:**
1. 「表示条件設定」でフローティングポップアップのカテゴリーフィルターを「特定カテゴリのみ表示」に設定
2. 対象カテゴリーの記事で表示されることを確認
3. 対象外カテゴリーの記事で表示されないことを確認

**確認ポイント:**
- ✅ 対象カテゴリーの記事で表示される
- ✅ 対象外カテゴリーの記事で表示されない
- ✅ コンソールにカテゴリーチェックのログが表示される（必要に応じて）

---

### E. A/Bテストのテスト

#### E-1. バリアント表示の確認
**前提条件:**
- A/Bテストが有効になっている
- 複数のバリアントが設定されている

**テスト手順:**
1. 記事ページを複数回リロード
2. コンソールでバリアントが変わることを確認：
   ```
   [PopupTracking Debug XX:XX:XX] 📊 Recording POPUP impression
      variant: "A" または "B" など
   ```
3. ダッシュボードで各バリアントの表示数が記録されていることを確認

**確認ポイント:**
- ✅ 異なるバリアントが表示される
- ✅ 各バリアントの表示数が正しく記録される
- ✅ ダッシュボードでバリアント別の統計が表示される

---

### F. CTR異常値の確認テスト

#### F-1. CTR異常値解析ページの確認
**前提条件:**
- 何らかのイベントが記録されている

**テスト手順:**
1. 「CTR異常値解析」ページを開く
2. 以下の情報を確認：
   - イベントタイプ別の統計
   - 重複ログの数
   - セッション別のイベント数
3. 重複率が10%を超えている場合は問題の可能性

**確認ポイント:**
- ✅ 重複率が低い（10%以下が理想）
- ✅ 各イベントタイプの記録数が正常
- ✅ セッションIDが正しく設定されている

---

## 🐛 異常系テスト

### 1. 表示数が記録されない場合の確認
**確認項目:**
- コンソールに「❌ Modal not found」などのエラーログがないか
- 画像が正しく設定されているか
- ターゲティング設定が正しいか
- セッションIDが設定されているか

### 2. クリック数が記録されない場合の確認
**確認項目:**
- コンソールに「❌ Click event ignored: impression not recorded yet」ログがないか
- 表示数が先に記録されているか
- 重複防止ロジックが働きすぎていないか

### 3. CTRが異常に高い場合の確認
**確認項目:**
- 表示数が正しく記録されているか（表示数が少なすぎないか）
- クリック数が重複して記録されていないか
- セッションIDが正しく管理されているか
- サーバー側の重複チェックが機能しているか

---

## 📊 ダッシュボードでの確認

### 正常な動作の確認ポイント
1. **表示数の確認**
   - 各イベントで表示数が1ずつ増える
   - 同じセッション・同じ記事では重複しない

2. **クリック数の確認**
   - クリック時にクリック数が1増える
   - 表示数に対してクリック数が多すぎない

3. **CTRの確認**
   - ポップアップ: 通常5%程度が正常
   - フローティングバナー: 通常1%程度が正常
   - 20%以上は異常値の可能性

4. **セッション管理**
   - 同じセッションIDで複数のイベントが記録される
   - セッションIDが正しく設定されている

---

## ✅ テスト完了チェックリスト

### 基本機能
- [ ] ポップアップが表示される
- [ ] ポップアップのクリックが記録される
- [ ] フローティングポップアップ（PC）が表示される
- [ ] フローティングポップアップ（モバイル）が表示されない
- [ ] フローティングバナーが表示される
- [ ] フローティングバナーのクリックが記録される

### デバッグログ
- [ ] すべてのイベントでコンソールログが表示される
- [ ] セッションIDが表示される
- [ ] 重複防止ログが表示される（適切な場合）
- [ ] エラーログが表示されない

### データの正確性
- [ ] ダッシュボードの表示数が正しい
- [ ] ダッシュボードのクリック数が正しい
- [ ] CTRが正常な範囲内
- [ ] 重複記録がない

### カテゴリーフィルター
- [ ] 対象カテゴリーで表示される
- [ ] 対象外カテゴリーで表示されない

### A/Bテスト
- [ ] 複数のバリアントが表示される
- [ ] 各バリアントの統計が記録される

---

## 🔍 トラブルシューティング

### 問題: ログが表示されない
**解決方法:**
1. ブラウザのコンソールを開いているか確認
2. ページをリロード
3. プラグインが有効になっているか確認

### 問題: 表示数が増えない
**解決方法:**
1. コンソールでエラーログを確認
2. 画像が正しく設定されているか確認
3. ターゲティング設定を確認
4. セッションIDが設定されているか確認

### 問題: クリック数が増えない
**解決方法:**
1. 表示数が先に記録されているか確認
2. コンソールで「impression not recorded yet」ログがないか確認
3. サーバー側の重複チェックが働きすぎていないか確認

### 問題: CTRが異常に高い
**解決方法:**
1. コンソールで重複記録がないか確認
2. 「CTR異常値解析」ページで重複率を確認
3. セッションIDが正しく管理されているか確認
4. サーバー側の重複チェックが機能しているか確認

---

## 📝 テスト結果記録用テンプレート

```
## テスト実施日: YYYY-MM-DD
## テスト実施者: [名前]
## テスト環境: [ブラウザ名/バージョン]

### テスト結果

#### A. ポップアップテスト
- A-1. 基本表示: [✅/❌] コメント: 
- A-2. クリック: [✅/❌] コメント: 
- A-3. 重複防止: [✅/❌] コメント: 

#### B. フローティングポップアップテスト
- B-1. PC表示: [✅/❌] コメント: 
- B-2. モバイル非表示: [✅/❌] コメント: 
- B-3. クリック: [✅/❌] コメント: 

#### C. フローティングバナーテスト
- C-1. 表示: [✅/❌] コメント: 
- C-2. 画像読み込み待ち: [✅/❌] コメント: 
- C-3. クリック: [✅/❌] コメント: 

#### D. カテゴリーフィルターテスト
- D-1. フィルター機能: [✅/❌] コメント: 

### 発見した問題
1. [問題内容]
2. [問題内容]

### 改善提案
1. [提案内容]
2. [提案内容]
```

---

**最終更新日:** 2025-12-25
**バージョン:** 3.3.2

